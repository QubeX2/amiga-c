#include "start.h"
#include <stdio.h>

static struct IntuitionBase *IntuitionBase;
static struct GfxBase *GfxBase;
static struct ExecBase *SysBase;
static struct DosLibrary *DosBase;

static struct Custom *custom = (struct Custom*)0xdff000;

static struct View *my_old_view;
static UWORD old_dmacon;
static UWORD old_intena;
static UWORD old_adkcon;
static ULONG level2_vector;
static ULONG level3_vector;

static UBYTE *ICRA=(UBYTE *)0xbfed01;

/**
 * 
 */
void wait_raster(ULONG raster)
{
	raster <<= 8;
	raster &= 0x1ff00;
	// not pretty, but creates pretty much same code as the asm source (MOVE.L)
	while(raster != ((*(volatile ULONG*) &custom->vposr) & 0x1ff00))
	{}
}

/**
 * 
 */
#define MOD_SIZE (339546)
static UBYTE __chip mod_data[MOD_SIZE];

void init_music(STRPTR modpath, BOOL is_pal)
{
    FILE *fp = fopen(modpath, "rb");
    int bytes_read = fread(mod_data, sizeof(UBYTE), MOD_SIZE, fp);
    fclose(fp);
    void *p_samples = NULL;
    UBYTE start_pos = 0;
    mt_install_cia(custom, NULL, is_pal);
    mt_init(custom, mod_data, p_samples, start_pos);
    mt_Enable = 1;
}

/**
 * 
 */
BOOL init_display()
{
    LoadView(NULL);
    WaitTOF();
    WaitTOF();
    return (((struct GfxBase *) GfxBase)->DisplayFlags & PAL) == PAL;
}

/**
 * 
 */
BOOL init_system(ULONG coplist)
{
    old_dmacon = custom->dmaconr;
    old_dmacon |= (DMAF_SETCLR | DMAF_MASTER);
    old_intena = custom->intenar;
    old_adkcon = custom->adkconr;

    // save current vectors
    level2_vector = *(ULONG *)0x68;
    level3_vector = *(ULONG *)0x6c;

    // Open the Intuition library:
	IntuitionBase = (struct IntuitionBase *) OpenLibrary("intuition.library", 0 );
	if( !IntuitionBase ) 
		close_system("Could NOT open the Intuition library!");

    // Open the Graphics library:
	GfxBase = (struct GfxBase *) OpenLibrary("graphics.library", 0 );
	if( !GfxBase )
		close_system("Could NOT open the Graphics library!");

    DosBase = (struct DosLibrary *) OpenLibrary("dos.library", 0);
    if( !DosBase )
        close_system("Could NOT open the Dos library!");

    // Save the current View, so we can restore it later:
	my_old_view = GfxBase->ActiView;

    SetTaskPri(FindTask(NULL), TASK_PRIORITY);
    BOOL is_pal = init_display();
    init_music("assets/modules/OroIncenso.mod", is_pal);
    printf("PAL display: %d\n", is_pal);

    custom->cop1lc = coplist;
    
	Forbid();
	Disable();
	WaitBlit();
    OwnBlitter(); 

    wait_raster(303);

    // disable dma and interupts
    custom->dmacon = 0x7fff;
    custom->intena = 0x7fff;
    custom->intreq = 0x7fff;
    custom->intreq = 0x7fff;

    *ICRA=0x7f;

    return TRUE;
}

/**
 * 
 */
void close_system(STRPTR message) 
{
    mt_Enable = 0;
    mt_end(custom);
    mt_remove_cia(custom);    

    *(ULONG *)0x68 = level2_vector;
    *(ULONG *)0x6c = level3_vector;

    // disable dma and interupts
    custom->dmacon = 0x7fff;
    custom->intena = 0x7fff;
    custom->intreq = 0x7fff;

    custom->adkcon = old_adkcon;
    custom->dmacon = old_dmacon | (DMAF_MASTER | DMAF_RASTER);
    custom->intena = old_intena | (INTF_SETCLR | INTF_INTEN);

    *ICRA = 0x9b;

    Enable();
	Permit();

    DisownBlitter();

    // Close the Graphics library:
	if(GfxBase)
		CloseLibrary((struct Library *)GfxBase);

	// C Close the Intuition library:
	if(IntuitionBase)
		CloseLibrary((struct Library *)IntuitionBase);

    if(DosBase)
        CloseLibrary((struct Library *)DosBase);

	// Restore the old View:
	LoadView(my_old_view);
    WaitTOF();
    WaitTOF();
    custom->cop1lc = (ULONG) GfxBase->copinit;
    custom->cop2lc = (ULONG) GfxBase->LOFlist;
    RethinkDisplay();

	// Print the message and leave: 
	printf( "%s\n", message );

	exit(0);
}

WORD sintable[] = {
    0x0004, 0x0009, 0x000d, 0x0012, 0x0016, 0x001b, 0x001f, 0x0024, 0x0028, 0x002c,
    0x0031, 0x0035, 0x003a, 0x003e, 0x0042, 0x0047, 0x004b, 0x004f, 0x0053, 0x0058,
    0x005c, 0x0060, 0x0064, 0x0068, 0x006c, 0x0070, 0x0074, 0x0078, 0x007c, 0x0080,
    0x0084, 0x0088, 0x008b, 0x008f, 0x0093, 0x0096, 0x009a, 0x009e, 0x00a1, 0x00a5,
    0x00a8, 0x00ab, 0x00af, 0x00b2, 0x00b5, 0x00b8, 0x00bb, 0x00be, 0x00c1, 0x00c4,
    0x00c7, 0x00ca, 0x00cc, 0x00cf, 0x00d2, 0x00d4, 0x00d7, 0x00d9, 0x00db, 0x00de,
    0x00e0, 0x00e2, 0x00e4, 0x00e6, 0x00e8, 0x00ea, 0x00ec, 0x00ed, 0x00ef, 0x00f1,
    0x00f2, 0x00f3, 0x00f5, 0x00f6, 0x00f7, 0x00f8, 0x00f9, 0x00fa, 0x00fb, 0x00fc,
    0x00fd, 0x00fe, 0x00fe, 0x00ff, 0x00ff, 0x00ff, 0x0100, 0x0100, 0x0100, 0x0100,
    0x0100, 0x0100, 0x0100, 0x00ff, 0x00ff, 0x00ff, 0x00fe, 0x00fe, 0x00fd, 0x00fc,
    0x00fb, 0x00fa, 0x00f9, 0x00f8, 0x00f7, 0x00f6, 0x00f5, 0x00f3, 0x00f2, 0x00f1,
    0x00ef, 0x00ed, 0x00ec, 0x00ea, 0x00e8, 0x00e6, 0x00e4, 0x00e2, 0x00e0, 0x00de,
    0x00db, 0x00d9, 0x00d7, 0x00d4, 0x00d2, 0x00cf, 0x00cc, 0x00ca, 0x00c7, 0x00c4,
    0x00c1, 0x00be, 0x00bb, 0x00b8, 0x00b5, 0x00b2, 0x00af, 0x00ab, 0x00a8, 0x00a5,
    0x00a1, 0x009e, 0x009a, 0x0096, 0x0093, 0x008f, 0x008b, 0x0088, 0x0084, 0x0080,
    0x007c, 0x0078, 0x0074, 0x0070, 0x006c, 0x0068, 0x0064, 0x0060, 0x005c, 0x0058,
    0x0053, 0x004f, 0x004b, 0x0047, 0x0042, 0x003e, 0x003a, 0x0035, 0x0031, 0x002c,
    0x0028, 0x0024, 0x001f, 0x001b, 0x0016, 0x0012, 0x000d, 0x0009, 0x0004, 0x0000,
    0xfffc, 0xfff7, 0xfff3, 0xffee, 0xffea, 0xffe5, 0xffe1, 0xffdc, 0xffd8, 0xffd4,
    0xffcf, 0xffcb, 0xffc6, 0xffc2, 0xffbe, 0xffb9, 0xffb5, 0xffb1, 0xffad, 0xffa8,
    0xffa4, 0xffa0, 0xff9c, 0xff98, 0xff94, 0xff90, 0xff8c, 0xff88, 0xff84, 0xff80,
    0xff7c, 0xff78, 0xff75, 0xff71, 0xff6d, 0xff6a, 0xff66, 0xff62, 0xff5f, 0xff5b,
    0xff58, 0xff55, 0xff51, 0xff4e, 0xff4b, 0xff48, 0xff45, 0xff42, 0xff3f, 0xff3c,
    0xff39, 0xff36, 0xff34, 0xff31, 0xff2e, 0xff2c, 0xff29, 0xff27, 0xff25, 0xff22,
    0xff20, 0xff1e, 0xff1c, 0xff1a, 0xff18, 0xff16, 0xff14, 0xff13, 0xff11, 0xff0f,
    0xff0e, 0xff0d, 0xff0b, 0xff0a, 0xff09, 0xff08, 0xff07, 0xff06, 0xff05, 0xff04,
    0xff03, 0xff02, 0xff02, 0xff01, 0xff01, 0xff01, 0xff00, 0xff00, 0xff00, 0xff00,
    0xff00, 0xff00, 0xff00, 0xff01, 0xff01, 0xff01, 0xff02, 0xff02, 0xff03, 0xff04,
    0xff05, 0xff06, 0xff07, 0xff08, 0xff09, 0xff0a, 0xff0b, 0xff0d, 0xff0e, 0xff0f,
    0xff11, 0xff13, 0xff14, 0xff16, 0xff18, 0xff1a, 0xff1c, 0xff1e, 0xff20, 0xff22,
    0xff25, 0xff27, 0xff29, 0xff2c, 0xff2e, 0xff31, 0xff34, 0xff36, 0xff39, 0xff3c,
    0xff3f, 0xff42, 0xff45, 0xff48, 0xff4b, 0xff4e, 0xff51, 0xff55, 0xff58, 0xff5b,
    0xff5f, 0xff62, 0xff66, 0xff6a, 0xff6d, 0xff71, 0xff75, 0xff78, 0xff7c, 0xff80,
    0xff84, 0xff88, 0xff8c, 0xff90, 0xff94, 0xff98, 0xff9c, 0xffa0, 0xffa4, 0xffa8,
    0xffad, 0xffb1, 0xffb5, 0xffb9, 0xffbe, 0xffc2, 0xffc6, 0xffcb, 0xffcf, 0xffd4,
    0xffd8, 0xffdc, 0xffe1, 0xffe5, 0xffea, 0xffee, 0xfff3, 0xfff7, 0xfffc, 0x0000,
    0x0004, 0x0009, 0x000d, 0x0012, 0x0016, 0x001b, 0x001f, 0x0024, 0x0028, 0x002c,
    0x0031, 0x0035, 0x003a, 0x003e, 0x0042, 0x0047, 0x004b, 0x004f, 0x0053, 0x0058,
    0x005c, 0x0060, 0x0064, 0x0068, 0x006c, 0x0070, 0x0074, 0x0078, 0x007c, 0x0080,
    0x0084, 0x0088, 0x008b, 0x008f, 0x0093, 0x0096, 0x009a, 0x009e, 0x00a1, 0x00a5,
    0x00a8, 0x00ab, 0x00af, 0x00b2, 0x00b5, 0x00b8, 0x00bb, 0x00be, 0x00c1, 0x00c4,
    0x00c7, 0x00ca, 0x00cc, 0x00cf, 0x00d2, 0x00d4, 0x00d7, 0x00d9, 0x00db, 0x00de,
    0x00e0, 0x00e2, 0x00e4, 0x00e6, 0x00e8, 0x00ea, 0x00ec, 0x00ed, 0x00ef, 0x00f1,
    0x00f2, 0x00f3, 0x00f5, 0x00f6, 0x00f7, 0x00f8, 0x00f9, 0x00fa, 0x00fb, 0x00fc,
    0x00fd, 0x00fe, 0x00fe, 0x00ff, 0x00ff, 0x00ff, 0x0100, 0x0100, 0x0100, 0x0100,
    0x0100, 0x0100, 0x0100, 0x00ff, 0x00ff, 0x00ff, 0x00fe, 0x00fe, 0x00fd, 0x00fc,
    0x00fb, 0x00fa, 0x00f9, 0x00f8, 0x00f7, 0x00f6, 0x00f5, 0x00f3, 0x00f2, 0x00f1,
    0x00ef, 0x00ed, 0x00ec, 0x00ea, 0x00e8, 0x00e6, 0x00e4, 0x00e2, 0x00e0, 0x00de,
    0x00db, 0x00d9, 0x00d7, 0x00d4, 0x00d2, 0x00cf, 0x00cc, 0x00ca, 0x00c7, 0x00c4,
    0x00c1, 0x00be, 0x00bb, 0x00b8, 0x00b5, 0x00b2, 0x00af, 0x00ab, 0x00a8, 0x00a5,
    0x00a1, 0x009e, 0x009a, 0x0096, 0x0093, 0x008f, 0x008b, 0x0088, 0x0084, 0x0080,
    0x007c, 0x0078, 0x0074, 0x0070, 0x006c, 0x0068, 0x0064, 0x0060, 0x005c, 0x0058,
    0x0053, 0x004f, 0x004b, 0x0047, 0x0042, 0x003e, 0x003a, 0x0035, 0x0031, 0x002c,
    0x0028, 0x0024, 0x001f, 0x001b, 0x0016, 0x0012, 0x000d, 0x0009, 0x0004, 0x0000,
    0xfffc, 0xfff7, 0xfff3, 0xffee, 0xffea, 0xffe5, 0xffe1, 0xffdc, 0xffd8, 0xffd4,
    0xffcf, 0xffcb, 0xffc6, 0xffc2, 0xffbe, 0xffb9, 0xffb5, 0xffb1, 0xffad, 0xffa8,
    0xffa4, 0xffa0, 0xff9c, 0xff98, 0xff94, 0xff90, 0xff8c, 0xff88, 0xff84, 0xff80,
    0xff7c, 0xff78, 0xff75, 0xff71, 0xff6d, 0xff6a, 0xff66, 0xff62, 0xff5f, 0xff5b,
    0xff58, 0xff55, 0xff51, 0xff4e, 0xff4b, 0xff48, 0xff45, 0xff42, 0xff3f, 0xff3c,
    0xff39, 0xff36, 0xff34, 0xff31, 0xff2e, 0xff2c, 0xff29, 0xff27, 0xff25, 0xff22,
    0xff20, 0xff1e, 0xff1c, 0xff1a, 0xff18, 0xff16, 0xff14, 0xff13, 0xff11, 0xff0f,
    0xff0e, 0xff0d, 0xff0b, 0xff0a, 0xff09, 0xff08, 0xff07, 0xff06, 0xff05, 0xff04,
    0xff03, 0xff02, 0xff02, 0xff01, 0xff01, 0xff01, 0xff00, 0xff00, 0xff00, 0xff00,
    0xff00, 0xff00, 0xff00, 0xff01, 0xff01, 0xff01, 0xff02, 0xff02, 0xff03, 0xff04,
    0xff05, 0xff06, 0xff07, 0xff08, 0xff09, 0xff0a, 0xff0b, 0xff0d, 0xff0e, 0xff0f,
    0xff11, 0xff13, 0xff14, 0xff16, 0xff18, 0xff1a, 0xff1c, 0xff1e, 0xff20, 0xff22,
    0xff25, 0xff27, 0xff29, 0xff2c, 0xff2e, 0xff31, 0xff34, 0xff36, 0xff39, 0xff3c,
    0xff3f, 0xff42, 0xff45, 0xff48, 0xff4b, 0xff4e, 0xff51, 0xff55, 0xff58, 0xff5b,
    0xff5f, 0xff62, 0xff66, 0xff6a, 0xff6d, 0xff71, 0xff75, 0xff78, 0xff7c, 0xff80,
    0xff84, 0xff88, 0xff8c, 0xff90, 0xff94, 0xff98, 0xff9c, 0xffa0, 0xffa4, 0xffa8,
    0xffad, 0xffb1, 0xffb5, 0xffb9, 0xffbe, 0xffc2, 0xffc6, 0xffcb, 0xffcf, 0xffd4,
    0xffd8, 0xffdc, 0xffe1, 0xffe5, 0xffea, 0xffee, 0xfff3, 0xfff7, 0xfffc, 0x0000
};
